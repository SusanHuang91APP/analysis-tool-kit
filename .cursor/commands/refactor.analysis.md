# Refactor Analysis Command

---

description: 對重構文件執行品質檢查與功能一致性比對，並將報告寫入文件第 15 節
scripts:
  sh: # 無需 shell script，純 AI 執行
  ps: # 無需 shell script，純 AI 執行

---

## 📖 指令說明

**功能**：針對由 `/refactor.plan` 生成的重構文件進行品質驗證，確保內容完整性、一致性與技術規範符合度。

**核心任務**：
1. 從重構文件提取來源分析文件清單
2. 執行 7 項功能一致性比對
3. 執行 4 層品質等級檢查（共 17 項）
4. 生成比對報告並更新至重構文件第 15 節

**與 `/refactor.plan` 的關係**：
- `/refactor.plan`：生成重構文件（Phase 0-3）
- `/refactor.analysis`：驗證重構文件品質（本指令）

---

## 📥 輸入參數

**格式**：`/refactor.analysis <refactorFiles...>`

**參數說明**：
- `refactorFiles`：一個或多個重構文件路徑
- 支援相對路徑和絕對路徑
- 支援 `@` 引用（Cursor 自動解析）

**範例**：
```bash
# 檢查單一文件
/refactor.analysis refactors/001-salepage/features/004-商品基本資訊與標籤.md

# 檢查多個文件
/refactor.analysis @004-商品基本資訊與標籤.md @008-商品頁群組.md

# 使用絕對路徑
/refactor.analysis /Users/susanhuang/.../refactors/001-salepage/features/004-商品基本資訊與標籤.md
```

---

## 🚀 執行流程

[ **CRITICAL**: 必須嚴格按照以下階段順序執行 ]

### Phase 0: 載入上下文 (Load Context)

**目標**：載入所有必要文件

#### 步驟 0.1: 驗證參數並讀取重構文件

**任務**：
1. 確認使用者提供了至少一個重構文件路徑
2. 使用 `read_file` 讀取所有重構文件
3. 從「1.1 📂 分析檔案資訊」章節提取來源分析文件路徑

**提取邏輯**：
```
1. 定位到「## 1.1 📂 分析檔案資訊 (Analyzed Files)」章節
2. 讀取表格中的「檔案路徑」欄位
3. 提取所有非 [待填寫] 的路徑
4. 轉換為絕對路徑列表
```

**輸出格式**：
```
✅ Phase 0.1: 重構文件讀取完成
   - 重構文件數: {N} 個
   - 來源文件數: {M} 個
   - 來源文件清單:
     1. analysis/001-salepage/features/004-商品基本資訊與標籤.md
     2. ...
```

**錯誤處理**：
- 未提供參數 → `❌ 錯誤：必須提供至少一個重構文件路徑`
- 文件不存在 → `❌ 錯誤：文件不存在：{path}`
- 缺少 1.1 節 → `❌ 錯誤：重構文件缺少「1.1 分析檔案資訊」章節`
- 1.1 節未填寫 → `❌ 錯誤：「1.1 分析檔案資訊」未填寫來源文件路徑`

---

#### 步驟 0.2: 讀取規範與來源文件

**任務**：
1. 讀取核心規範文件（2 個）
2. 讀取來源分析文件（步驟 0.1 提取的清單）

**必須讀取的規範文件**：
- `.analysis-kit/memory/refactor-constitution.md`
- `.analysis-kit/memory/refactor-coding-standard.md`

**輸出格式**：
```
✅ Phase 0.2: 規範與來源文件讀取完成
   - ✅ refactor-constitution.md
   - ✅ refactor-coding-standard.md
   - ✅ 來源分析文件: {M} 個（共 {total_lines} 行）
```

**Phase 0 完成檢查點**：
```
🎯 Phase 0 完成總結
   ✅ 已讀取 {N} 個重構文件
   ✅ 已讀取 2 個核心規範文件
   ✅ 已讀取 {M} 個來源分析文件
   
   → 準備進入 Phase 1: 品質檢查
```

---

### Phase 1: 品質檢查 (Quality Check)

**目標**：執行功能一致性比對與品質等級檢查

**[ 🔍 比對流程總覽 ]**

**階段 A：讀取對比文件（Phase 0）**
1. 讀取重構文件（目標文件）
2. 從重構文件第 1.1 節提取來源分析文件路徑
3. 讀取所有來源分析文件

**階段 B：功能一致性比對（Phase 1.1）**
1. **比對業務邏輯**：檢查計算公式、排序規則是否一致
2. **比對關鍵功能點**：檢查功能數量、描述是否完整
3. **比對 API 端點**：檢查路徑、參數、回應格式是否一致
4. **比對資料模型**：檢查所有欄位是否涵蓋
5. **比對互動流程**：檢查使用者操作步驟是否一致
6. **比對條件渲染**：檢查顯示/隱藏邏輯是否一致
7. **比對狀態變數**：檢查狀態數量、用途是否對應

**階段 C：品質等級檢查（Phase 1.2）**
1. **Level 1**：檢查必填項是否完整
2. **Level 2**：檢查內容與來源文件是否一致
3. **Level 3**：檢查技術規範是否符合憲法
4. **Level 4**：檢查是否可實作（檔案路徑、依賴）

**階段 D：生成報告（Phase 2）**
1. 整理比對結果（✅一致 / ⚠️不一致 / ➕新增）
2. 計算品質評分（總分/17）
3. 使用 `search_replace` 更新重構文件第 15 節

**階段 E：輸出建議（Phase 3）**
- 列出不一致項目（需人工確認）
- 列出待填寫項目（需補充資訊）
- 提供後續動作優先級（P0-P3）

---

#### 步驟 1.1: 功能一致性比對（7 項）

**任務**：比對來源文件與重構文件的功能一致性

**比對項目清單**：

| # | 比對項目 | 來源章節 | 重構章節 | 檢查重點 |
|---|---------|---------|---------|---------|
| 1 | 商業邏輯 | 4.2 | 5.5, 5.6 | 核心業務規則、排序/篩選/計算邏輯 |
| 2 | 關鍵功能點 | 2.1, 1.2 | 2.1 | 功能數量、描述、遺漏/新增項目 |
| 3 | API 端點 | 4.4.2 | 5.4 | API 路徑、參數、回應格式、錯誤處理 |
| 4 | 資料模型 | 4.4.2 | 5.1 | 資料結構欄位、型別、必填欄位 |
| 5 | 互動流程 | 3.2 | 7.1 | 使用者操作步驟、系統回應、錯誤處理 |
| 6 | 條件式渲染 | 3.3 | 5.5 | 所有條件判斷、顯示/隱藏邏輯 |
| 7 | 狀態變數 | 4.3 | 5.6 | 狀態變數數量、用途、來源 |

**比對結果標記**：
- `✅一致`：完全一致
- `⚠️不一致`：有差異，需人工確認
- `➕新增`：重構文件新增的內容

**輸出格式**：
```
✅ Phase 1.1 完成：功能一致性比對
   - 已完成 7/7 項比對
   - ✅ 一致: {N} 項
   - ⚠️ 不一致: {N} 項
   - ➕ 新增: {N} 項
```

---

#### 步驟 1.2: 品質等級檢查（4 層 17 項）

**任務**：執行 4 層品質檢查並計算總分

**Level 1: 必填項檢查（4 項）**
- [ ] 所有 `[待填寫]` 已合理保留（有明確理由）
- [ ] 所有章節有實質內容（非空白或範本文字）
- [ ] TypeScript 介面定義完整且有效
- [ ] 檔案路徑使用絕對路徑

**Level 2: 內容一致性檢查（4 項）**
- [ ] API 規格與源文件完全一致
- [ ] 資料模型涵蓋所有源文件提到的欄位
- [ ] 狀態管理策略明確且符合憲法規範
- [ ] 元件拆解與源文件的 UI 結構一致

**Level 3: 技術規範檢查（5 項）**
- [ ] 符合 Next.js 15 App Router 規範
- [ ] Server/Client Component 分離清楚且合理
- [ ] 資料獲取策略符合 `refactor-coding-standard.md`
- [ ] 狀態管理使用 Zustand（如需要）+ SWR（Client）
- [ ] 無使用對應表外的技術方案

**Level 4: 可實作性檢查（4 項）**
- [ ] 檔案路徑符合專案現有結構
- [ ] 所有依賴的服務已存在或已規劃建立
- [ ] 驗收標準可測試且明確
- [ ] 無循環依賴或架構衝突

**評分標準**：
- **優秀** (15-17 分)：可直接進入實作階段
- **良好** (12-14 分)：需小幅調整後可實作
- **需改善** (< 12 分)：需重大調整

**輸出格式**：
```
📊 品質檢查結果

✅ Level 1 (必填項): 通過 ({N}/4 項)
✅ Level 2 (內容一致性): 通過 ({N}/4 項)
⚠️ Level 3 (技術規範): 需改善 ({N}/5 項)
   - ⚠️ 項目名稱: 原因說明
✅ Level 4 (可實作性): 通過 ({N}/4 項)

總體評分: {score}/17
品質等級: ✅ 優秀 / ⚠️ 良好 / ❌ 需改善
```

**Phase 1 完成檢查點**：
```
🎯 Phase 1 完成總結
   ✅ 功能一致性比對: 7/7 項完成
   ✅ 品質等級檢查: 4 層完成
   ✅ 總分: {score}/17
   ✅ 品質等級: {等級}
   
   → 準備進入 Phase 2: 更新報告
```

---

### Phase 2: 更新報告 (Update Report)

**目標**：將比對報告寫入重構文件的第 15 節

[ **CRITICAL**: 必須使用 `search_replace` 工具，禁止覆蓋其他內容 ]

---

#### 步驟 2.1: 準備報告內容

**任務**：整理 Phase 1 的結果，準備符合範本格式的報告

**報告結構**：
```markdown
## 15. 功能一致性比對報告 (Functionality Consistency Report)

> **[AI 自動生成 - 功能一致性比對]**

此章節由 AI 自動生成，比對目標文件與源文件的功能一致性。

### 15.1 比對項目清單

| 比對項目 | 源文件章節 | 目標文件章節 | 比對結果 | 備註 |
|---------|-----------|-------------|---------|------|
| 商業邏輯 | 4.2 | 5.5, 5.6 | ✅一致 | - |
| 關鍵功能點 | 2.1, 1.2 | 2.1 | ✅一致 | - |
| API 端點 | 4.4.2 | 5.4 | ✅一致 | - |
| 資料模型 | 4.4.2 | 5.1 | ✅一致 | - |
| 互動流程 | 3.2 | 7.1 | ✅一致 | - |
| 條件式渲染 | 3.3 | 5.5 | ✅一致 | - |
| 狀態變數 | 4.3 | 5.6 | ✅一致 | - |

### 15.2 比對結果摘要

**✅ 一致項目**：{N} 項
- [項目名稱]：完全一致（簡要說明）

**⚠️ 不一致項目**：{N} 項（需要人工確認）
- [項目名稱]：[說明不一致的地方]

**➕ 新增項目**：{N} 項（AI 補充，需驗證）
- [項目名稱]：[說明新增的原因]

**統計**：
- 總比對項目：7 項
- ✅ 一致項目：{N} 項
- ⚠️ 不一致項目：{N} 項
- ➕ 新增項目：{N} 項

### 15.3 詳細比對說明

[針對每個不一致或新增項目的詳細說明]

### 15.4 品質檢查結果

📊 品質檢查結果

✅ Level 1 (必填項): 通過 ({N}/4 項)
✅ Level 2 (內容一致性): 通過 ({N}/4 項)
⚠️ Level 3 (技術規範): 需改善 ({N}/5 項)
✅ Level 4 (可實作性): 通過 ({N}/4 項)

總體評分: {score}/17
品質等級: {等級}
```

---

#### 步驟 2.2: 執行內容替換

**任務**：使用 `search_replace` 更新第 15 節

**參數說明**：
- `file_path`: 重構文件路徑
- `old_string`: 第 15 節的 [待填寫] 內容（包含足夠上下文）
- `new_string`: 步驟 2.1 準備的完整報告

**輸出格式**：
```
✅ Phase 2 完成：比對報告已更新
   - 已更新檔案: {path}
   - 更新章節: 第 15 節
   - 更新內容: 比對表格 + 摘要 + 詳細說明 + 品質結果
```

**Phase 2 完成檢查點**：
```
🎯 Phase 2 完成總結
   ✅ 比對報告已準備完成
   ✅ 已使用 search_replace 更新第 15 節
   ✅ 更新檔案數: {N} 個
   
   → 準備進入 Phase 3: 完成報告
```

---

### Phase 3: 完成報告 (Final Report)

**目標**：提供執行摘要與後續建議

---

#### 步驟 3.1: 輸出執行摘要

**輸出格式**：
```
╔════════════════════════════════════════════════════════╗
║          🎉 重構文件品質檢查完成                          ║
╚════════════════════════════════════════════════════════╝

📄 文件資訊
   - 檢查文件: {N} 個
   - 來源文件: {M} 個

📊 Phase 0: 載入上下文
   - ✅ 已讀取 {N} 個重構文件
   - ✅ 已讀取 2 個核心規範文件
   - ✅ 已讀取 {M} 個來源分析文件

🔍 Phase 1: 品質檢查
   - ✅ 功能一致性比對: {N}/7 項一致
   - ✅ 品質等級: {等級}（{score}/17 分）
   - 詳細結果:
     • Level 1 (必填項): {N}/4 通過
     • Level 2 (內容一致性): {N}/4 通過
     • Level 3 (技術規範): {N}/5 通過
     • Level 4 (可實作性): {N}/4 通過

✍️ Phase 2: 更新報告
   - ✅ 比對報告已附加到第 15 節
   - ✅ 更新檔案數: {N} 個
```

---

#### 步驟 3.2: 提供後續建議

**輸出格式**：
```
📌 建議後續動作

🔴 **優先級 P0**（必須立即處理）
   1. 檢視第 15 節比對報告
      - 如有 ⚠️ 不一致項目，必須人工確認
   2. 檢視所有 [待填寫] 標記
      - 確認哪些需要補充資訊

🟠 **優先級 P1**（重要但非緊急）
   3. 驗證所有 [技術棧轉換] 標記
   4. 補充相關文件連結（第 3 節）
   5. 確認 API 規格（第 5.4 節）

🟡 **優先級 P2**（建議處理）
   6. Review 資料模型（第 5.1 節）
   7. 確認狀態管理策略（第 6 節）
   8. 補充測試策略（第 12 節）

🟢 **優先級 P3**（可選）
   9. 團隊 Code Review
   10. 技術預研與 POC
```

**Phase 3 完成檢查點**：
```
╔════════════════════════════════════════════════════════╗
║          ✅ 所有階段執行完成                              ║
╚════════════════════════════════════════════════════════╝

🎯 總結
   - Phase 0: ✅ 載入上下文完成
   - Phase 1: ✅ 品質檢查完成
   - Phase 2: ✅ 更新報告完成
   - Phase 3: ✅ 完成報告生成

📁 重構文件: {path}

✨ 品質檢查已完成！可以根據建議開始重構實作。
```

---

## 🔑 關鍵規則

[ **CRITICAL**: AI 在執行所有步驟時必須遵守 ]

**規則 1: 來源文件提取**
- 必須從「1.1 📂 分析檔案資訊」章節提取來源文件路徑
- 不可自行假設或推測

**規則 2: 工具使用規範**
- 必須使用 `search_replace` 更新第 15 節
- 嚴禁直接覆蓋整個檔案內容

**規則 3: 比對結果標記**
- 所有比對結果必須標記為：`✅一致` / `⚠️不一致` / `➕新增`

**規則 4: 品質評分計算**
- 必須明確計算並顯示總分（總分/17）
- 評級標準：15-17 分（優秀）、12-14 分（良好）、< 12 分（需改善）

**規則 5: 完整性要求**
- 所有 7 項功能一致性比對必須執行
- 所有 4 層品質檢查必須執行

**規則 6: 錯誤處理**
- 重構文件缺少「1.1 分析檔案資訊」→ 立即終止
- 任何來源文件不存在 → 立即終止並列出缺失文件
- search_replace 失敗 → 回報詳細錯誤訊息

**規則 7: 輸出格式**
- 所有階段完成後必須輸出檢查點
- 確保使用者了解執行進度

---

## 🎯 成功標準

品質檢查視為成功完成，需滿足：

1. ✅ 所有 3 個 Phase 都已執行
2. ✅ 功能一致性比對：7/7 項完成
3. ✅ 品質等級檢查：4 層完成（共 17 項）
4. ✅ 比對報告已正確寫入第 15 節
5. ✅ 所有不一致項目都已標記

**品質檢查完成後，即可根據建議開始重構實作！** 🚀
